-- Header Section
-- VHDL testbench threshold_TB
-- Generated by HDLGen, Github https://github.com/abishek-bupathi/HDLGen
-- Reference: https://tinyurl.com/vicilogicVHDLTips 
-- Component Name : threshold
-- Title          : Generate a 32-x32-bit threshold array from 32x32-byte source data array
-- Description    : refer to component hdl model fro function description and signal dictionary
-- Author(s)      : Fearghal Morgan
-- Company        : University of Galway
-- Email          : fearghal.morgan@universityofgalway.ie
-- Date           : 13/01/2023

-- library declarations
library ieee;
use ieee.std_logic_1164.all;
use ieee.numeric_std.all;
use work.MAinPackage.all;

-- entity declaration
entity threshold_TB is end entity threshold_TB;

architecture behave of threshold_TB is

-- unit under test (UUT) component declaration. Identical to component entity, with 'entity' replaced with 'component'
component threshold is 
Port(
	clk : in std_logic;
	rst : in std_logic;
	ce : in std_logic;
	go : in std_logic;
	reg4x32_CSRA : in reg4x32_Array;
	reg4x32_CSRB : in reg4x32_Array;
	BRAM_dOut : in std_logic_vector(255 downto 0);
	active : out std_logic;
	wr : out std_logic;
	add : out std_logic_vector(7 downto 0);
	datToMem : out std_logic_vector(31 downto 0);
	functBus : out std_logic_vector(95 downto 0) 
	);
end component;

-- testbench signal declarations
signal testNo: integer; -- aids locating test in simulation waveform
signal endOfSim : boolean := false; -- assert at end of simulation to highlight simulation done. Stops clk signal generation.

-- Typically use the same signal names as in the VHDL entity, with keyword signal added, and without in/out mode keyword

signal clk: std_logic := '1';
signal rst: std_logic;        

signal ce : std_logic;
signal go : std_logic;
signal reg4x32_CSRA : reg4x32_Array;
signal reg4x32_CSRB : reg4x32_Array;
signal BRAM_dOut : std_logic_vector(255 downto 0);
signal active : std_logic;
signal wr : std_logic;
signal add : std_logic_vector(7 downto 0);
signal datToMem : std_logic_vector(31 downto 0);
signal functBus : std_logic_vector(95 downto 0);

constant period: time := 20 ns; -- Default simulation time. Use as simulation delay constant, or clk period if sequential model ((50MHz clk here)
 
signal resultMem : reg32x32_Array;

begin

-- Generate clk signal, if sequential component, and endOfSim is FALSE.
clkStim: clk <= not clk after period/2 when endOfSim = false else '0';

-- instantiate unit under test (UUT)
UUT: threshold-- map component internal sigs => testbench signals
port map
	(
	clk => clk, 
	rst => rst, 
	ce => ce, 
	go => go, 
	reg4x32_CSRA => reg4x32_CSRA, 
	reg4x32_CSRB => reg4x32_CSRB, 
	BRAM_dOut => BRAM_dOut, 
	active => active, 
	wr => wr, 
	add => add, 
	datToMem => datToMem, 
	functBus => functBus
	);

-- Signal stimulus process
stim_p: process -- process sensitivity list is empty, so process automatically executes at start of simulation. Suspend process at the wait; statement
begin
    report "%N Simulation start, time = " & time'image(now);

	-- Apply default INPUT signal values. Do not assign output signals (generated by the UUT) in this stim_p process
	-- Each stimulus signal change occurs 0.2*period after the active low-to-high clk edge
	-- if signal type is
	-- std_logic, use '0'
	-- std_logic_vector use (others => '0')
	-- integer use 0
	ce <= '0';
	go <= '0';
	reg4x32_CSRA <= (others =>(others => '0'));
	reg4x32_CSRB <= (others =>(others => '0'));
	BRAM_dOut <= (others => '0');
	report "%N Simulation start";

	report "Assert and toggle rst";
	testNo <= 0;
	rst    <= '1';
	wait for period*1.2; -- assert rst for 1.2*period, deasserting rst 0.2*period after active clk edge
	rst   <= '0';
	wait for period; -- wait 1 clock period
	-- include testbench stimulus sequence here. USe new testNo for each test set	-- individual tests. Generate input signal combinations and wait for period.
	testNo <= 1;
	wait for 3*period;


-- manually added code START
   -- include testbench stimulus sequence here. Use new testNo for each test set
   -- Use new testNo for each test set 
   -- individual tests. Generate input signal combinations and wait for period.
    testNo <= 1;
    BRAM_dOut <= X"1f1e1d1c1b1a191817161514131211100f0e0d0c0b0a09080706050403020100"; 
	reg4x32_CSRA <= (others => (others => '0')); 
	reg4x32_CSRA(0)(31 downto 24) <= X"03";
	ce <= '1';
	go <= '1';
	wait for period;
	go <= '0';
    wait for 1200*period;  
-- manually added code END

	-- Print picosecond (ps) = 1000*ns (nanosecond) time to simulation transcript
    -- Use to find time when simulation ends (endOfSim is TRUE)
    -- Re-run the simulation for this time
    -- Select timing diagram and use View>Zoom Fit
    report "%N Simulation end, time = " & time'image(now);
	endOfSim <= TRUE; -- assert flag to stop clk signal generation

	wait; -- wait forever
end process; 

-- write to resultMem or assertion of signal wr
wrResultMem: process (clk, rst)
begin
	if rst = '1' then
	   resultMem <= (others => (others => '0'));
    elsif rising_edge(clk) then
      if wr = '1' then
        if unsigned(add(7 downto 5)) = "010" then -- resultMem address bank
      	  resultMem(to_integer( unsigned(add(4 downto 0)) )) <= datToMem;
        end if;
      end if;
 	end if; 
end process; 


end behave;